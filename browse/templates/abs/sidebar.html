{%- macro google_scholar_link(abs_meta, authors) -%}
  {%- set author_params = namespace(value="") -%}
  {%- set author_count = namespace(value=0) -%}
  {%- set max_authors = 2 -%}
  {%- for author in authors[0] -%}
    {%- if author_count.value < max_authors and author is not string -%}
      {%- set author_params.value = author_params.value + '&author=' + author[0] |urlencode -%}
      {%- set author_count.value = author_count.value + 1 -%}
    {%- endif -%}
  {%- endfor -%}
  {%- set first_dt = abs_meta.get_datetime_of_version(version=0) -%}
  <a  class="abs-button abs-button-small cite-google-scholar" href="https://scholar.google.com/scholar_lookup?title={{ abs_meta.title|urlencode }}{{ author_params.value }}&publication_date={{ first_dt.strftime('%Y/%m/%d') }}&arxiv_id={{ abs_meta.arxiv_id }}" target="_blank" rel="noopener">Google Scholar</a>
{%- endmacro -%}

{%- macro generate_ancillary_file_list(anc_file_list=[], cutoff=6) -%}
<ul>
  {%- for anc_file in anc_file_list -%}
    {% if loop.index == cutoff and anc_file_list|length > cutoff %}
  <div id="long-anc-list"><ul>
    {% endif %}
  <li><a href="{{url_for('.src',arxiv_id=abs_meta.arxiv_id_v,file_name=anc_file['name'])}}" class="anc-file-name">{{ anc_file['name'] }}</a></li>
  {%- endfor -%}
  {% if anc_file_list|length > cutoff %}
    {%- set num_files_not_shown = anc_file_list|length - cutoff + 1 -%}
  </ul></div>
  <ul class="no-bullet"><li><a href="javascript:toggleList('long-anc-list','{{ num_files_not_shown }} additional file{% if num_files_not_shown > 1 %}s{% endif %} not shown');" title="Show entire file list." id="toggle" class="anc-additional-file">({{ num_files_not_shown }} additional file{% if num_files_not_shown > 1 %}s{% endif %} not shown)</a><noscript>&nbsp;You must enabled JavaScript to view entire file list.</noscript></li></ul>
  {% else %}
</ul>
  {% endif %}
{%- endmacro -%}

{%- macro generate_download_links(format_list=[]) -%}
<ul class="arxiv-download-links" role="group" aria-label="available download formats">
  {%- set current = abs_meta.version == abs_meta.version_history[-1].version -%}
  {%- if format_list|length == 0 or ( not current and format_list|length == 1 and format_list[0] == 'src' ) -%}
  <span class="disabled">Unavailable</span>
  {% else %}
    {#- We have to skip the 'src' format unless we're viewing the current version of the article -#}
    {%- for format in format_list if not (format == 'src' and not current) %}
    {%- if format == 'src' -%}
    <li><a href="{{url_for('.eprint', arxiv_id=requested_id)}}" class="">Source</a></li>
    {%- elif format.startswith('ps') -%}
    <li><a href="{{url_for('.ps', arxiv_id=requested_id)}}" class="">PostScript{% if format.endswith('(400)') %} (400 dpi){% elif format.endswith('(600)') %} (600 dpi){% elif format.endswith('(cm)') %} (Type I cm){% elif format.endswith('(CM)') %} (Type I CM){% endif %}</a></li>
    {%- elif format == 'dvi' -%}
    <li><a href="{{url_for('.dvi', arxiv_id=requested_id)}}" class="">{{ format.upper() }}</a></li>
    {%- elif format == 'html' -%}
    <li><a href="{{url_for('.html', arxiv_id=requested_id)}}" accesskey="f" class="">{{ format.upper() }}</a></li>
    {%- elif format == 'other' -%}
    <li><a href="{{url_for('.format', arxiv_id=requested_id)}}" class="">Other formats</a></li>
    {%- elif format == 'nops' -%}
    <li><a href="{{url_for('.ps', arxiv_id=requested_id)}}" class="disabled">(PostScript unavailable)</a></li>
    {%- elif format == 'sciencewise_pdf' -%}
    {#- TODO: consider this format for deprecation -#}
    {#- TODO: create clickthrough link from sciencewise link -#}
    <li><a href="http://sciencewise.info/media/pdf/{{ abs_meta.arxiv_id_v }}.pdf" title="Tagged PDF on ScienceWISE.info" class="abs-button tag-sciencewise">Tagged PDF</a>
    <li><a href="http://sciencewise.info/media/pdf/{{ abs_meta.arxiv_id_v }}.pdf" title="Tagged PDF on ScienceWISE.info" class="abs-button tag-sciencewise">
      <img src="https://arxiv.org/icons/sciencewise75x32.png" height="16" width="38" alt="ScienceWISE" />
    </a></li>
    {%- endif -%}
    {%- endfor -%}
  {%- endif -%}
</ul>
{%- endmacro -%}

{%- macro generate_browse_context() -%}
  {{ base_macros.universalsearch("Search within category","&classification-{{ browse_context }}=y") }}
  <div class="arxiv-prevnext">
    {% if browse_context_previous_url -%}
    <span class="arrow">
      <a class="abs-button prev-url" href="{{browse_context_previous_url }}"
         accesskey="p" title="previous in {{ browse_context }} (accesskey p)">&lt; prev paper</a>
    </span>
    <span class="is-hidden-mobile"> | </span>
    {%- else -%}
    <span class="nolink" class="abs-button prev-url">&lt; prev</span>
    <span class="is-hidden-mobile"> | </span>
    {% endif -%}
    {% if browse_context_next_url %}
    <span class="arrow">
      <a class="abs-button next-url" href="{{browse_context_next_url}}" accesskey="n"
         title="next in {{ browse_context }} (accesskey n)">next paper &gt;</a>
    </span>
    {%- else -%}
    <span class="abs-button next-url" class="nolink">next &gt;</span>
    {%- endif -%}
    <br/>
  </div>{#end div.prevnext#}

  {%- if browse_context != 'arxiv' -%}
  {#- This fixes a bug in the classic UI logic -#}
  <a class="arxiv-browse-new-papers" href="{{url_for('.list_articles',context=browse_context, subcontext='new')}}">All new <strong>{{ browse_context }}</strong></a>
  {%- endif -%}

  {%- if not abs_meta.arxiv_identifier.is_old_id and (abs_meta.get_browse_context_list()|length > 1) -%}
  <div class="abs-switch-cat">
    Change browse category:
    <div class="switch context-change">
      {% for category in abs_meta.get_browse_context_list() if not (browse_context==category) %}
        {%- set switch_url = url_for('browse.abstract', arxiv_id=abs_meta.arxiv_identifier.id, context=category) -%}
        {% if '.' in category %}
        <a class="subclass" href="{{ switch_url}}">{{ category }}</a>
        {% else %}
        <a href="{{ switch_url}}">{{ category }}</a>
        {% endif %}
      {% endfor %}
    </div>
  </div>
  {% endif %}
{%- endmacro -%}


{%- macro generate_dblp_section(author_cutoff=5) -%}
  <div class="dblp">
    <h3><a href="{{ dblp.base_url }}">DBLP</a> - CS Bibliography</h3>
    <div class="list">
      <a href="{{ dblp.listing_url }}" title="listing on DBLP">listing</a>{% if dblp.bibtex_path %} | <a href="{{ dblp.bibtex_base_url }}/{{ dblp.bibtex_path }}" title="DBLP bibtex record">bibtex</a>{% endif %}
    </div>
    {% if dblp.author_list %}
    <div class="list">
      {% for author in dblp.author_list[:author_cutoff] %}
      {#- The only reason entity_to_utf is being used is becasue dblp has xml entities in the DB -#}
      <a href="{{ dblp.author_search_url }}?author={{ author|entity_to_utf|urlencode }}" title="DBLP author search">{{ author|entity_to_utf }}</a>{% if not loop.last %}<br/>{%- endif -%}
    {% endfor %}
    {% if dblp.author_list|length > author_cutoff %}
      <div class="list">&hellip;</div>
    {% endif %}
    </div>
    {% endif %}
  </div>
{%- endmacro -%}

{%- block sidebar -%}
{#- TODO: CAN WE USE BOOTSTRAP ELEMENTS INSTEAD? -#}
{#- TODO: check whether anything but the ancillary files section uses this -#}
{%- if ancillary_files %}
<script type="text/javascript">
<!--
function toggleList(whichLayer,toggleThis)
{
  var elem, vis;
  if( document.getElementById ) // standard
    elem = document.getElementById( whichLayer );
  else if( document.all ) // old msie versions
    elem = document.all[whichLayer];
  else if( document.layers ) // nn4
    elem = document.layers[whichLayer];
  vis = elem.style;
  // if the style.display value is blank we try to figure it out here
  if(vis.display==''&&elem.offsetWidth!=undefined&&elem.offsetHeight!=undefined)
    vis.display = (elem.offsetWidth!=0&&elem.offsetHeight!=0)?'inline':'none';
  vis.display = (vis.display==''||vis.display=='inline')?'none':'inline';
  // toggle link inner text
  status = vis.display;
  if(vis.display=='inline'){
    document.getElementById('toggle').innerHTML = "(collapse list)";
    document.getElementById('toggle').title = "Collapse list";
  } else {
    document.getElementById('toggle').innerHTML = "("+toggleThis+")";
    document.getElementById('toggle').title = "Show complete list";
  }
}
//-->
</script>
{% endif %}

<div class="arxiv-downloads row align-items-center g-1">
  <div class="col-auto">
    {{ generate_download_button('btn-lg') }}
  </div>
  <div class="col-auto">
    {%- if abs_meta.license.icon_uri_path -%}
    <a href="{{abs_meta.license.effective_uri}}" title="Rights to this article"><img src="https://arxiv.org{{ abs_meta.license.icon_uri_path }}"/></a>
    <svg width="20" height="20" fill="currentColor" role="presentation" id="mytooltip" type="button" data-bs-custom-class="arxiv-tooltip" data-bs-toggle="tooltip" data-bs-placement="top" title="Tooltip on top">
      <use xlink:href="{{ url_for('base.static', filename='bootstrap/bootstrap-icons.svg') }}#question-circle"/>
    </svg>
    {%- else -%}
    <a href="{{abs_meta.license.effective_uri}}" title="Rights to this article">License</a>
    <a href="{{abs_meta.license.effective_uri}}" data-bs-custom-class="arxiv-tooltip" data-bs-toggle="tooltip" data-placement="top" title="Copyright is owned by the author. Check the license for usage rights.">
      <svg width="20" height="20" fill="currentColor" role="presentation">
        <use xlink:href="{{ url_for('base.static', filename='bootstrap/bootstrap-icons.svg') }}#question-circle"/>
      </svg>
    </a>
    {%- endif -%}
  </div>
  <div class="arxiv-sidebar-more col-12 py-1">
    <div class="accordion accordion-flush" id="other-formats">
      <div class="accordion-item">
        <h2 class="accordion-header" id="flush-headingFormats">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseFormats" aria-expanded="false" aria-controls="flush-collapseFormats">
            Other Formats
          </button>
        </h2>
        <div id="flush-collapseFormats" class="accordion-collapse collapse" aria-labelledby="flush-headingFormats" data-bs-parent="#other-formats">
          <div class="accordion-body">
            {{ generate_download_links(format_list=formats) }}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="arxiv-browse-context border rounded-2 p-3 w-100">
{{ generate_browse_context() }}
</div>

{% include "abs/submission-history.html" %}

{% include "abs/cite.html" %}

{% include "abs/bookmarking.html" %}

{% include "abs/other-services.html" %}

{%- if ancillary_files %}
<div class="card arxiv-submission-history">
  <div class="card-body">
    <h4 class="card-title">Ancillary-file links</h4>
    <div class="card-text">
      <h5>Ancillary files <span style="font-size:75%;font-weight:normal">(<a href="/src/{{ abs_meta.arxiv_id_v }}/anc">details</a>)</span>:</h5>
      {{ generate_ancillary_file_list(ancillary_files)}}
    </div>
  </div>
</div>
{% endif %}

{% if trackback_ping_count and trackback_ping_count > 0 %}
<div class="card arxiv-submission-history">
  <div class="card-body">
    <h4 class="card-title">Trackbacks</h4>
    <div class="card-text">
      <h5><a class="trackback-link" href="/tb/{{ abs_meta.arxiv_id }}"> {{ trackback_ping_count }} blog link{% if trackback_ping_count > 1 %}s{% endif %}</a></h5>
      <p>(<a href="{{url_for('help_trackback')}}" class="trackback-help">what is this?</a>)</p>
    </div>
  </div>
</div>
{% endif %}

{#- DBLP is a bibliographical database primarily for Computer Science papers -#}
{%- if dblp -%}
{{ generate_dblp_section() }}
{%- endif -%}
{% endblock sidebar %}
